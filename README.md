# C++ MySQL 连接池

## 项目简介

这是一个基于 C++11 实现的 MySQL 数据库连接池项目。通过连接池技术，可以有效地复用数据库连接，减少频繁创建和销毁连接带来的性能开销，尤其适用于高并发的服务器环境。

本项目使用了 C++11 的新特性，如`线程`、`智能指针`、`锁`和`条件变量`，实现了一个线程安全的、可配置的、自动管理的连接池。

## 功能特性

- **线程安全**: 在多线程环境下可以安全地获取和归还连接。
- **单例模式**: 确保全局只有一个连接池实例。
- **智能指针管理**: 使用 `std::shared_ptr` 自动管理连接的生命周期，连接使用完毕后自动归还连接池，防止内存泄漏。
- **配置灵活**: 通过 `mysql.ini` 配置文件可以灵活配置连接池的各项参数。
- **动态扩容**: 当连接池中无可用连接时，可以动态创建新连接，直到达到设定的最大连接数。
- **连接保活与回收**: 定时扫描连接池，自动回收空闲时间过长的连接，维持连接池的健康状态。
- **超时等待**: 获取连接时可设置超时时间，避免线程长时间阻塞。

## 环境依赖

- **C++ 编译器**: 支持 C++11 及以上标准的编译器 (如 Visual Studio 2015+, g++ 5.0+)。
- **MySQL C API**: 项目依赖 MySQL 官方的 C 语言 API 库 (`libmysql.lib`, `libmysql.dll`) 来与数据库交互。本项目已包含 `libmysql.dll`。

## 如何使用

### 1. 编译

本项目是一个 Visual Studio 2022 项目。

1.  使用 Visual Studio 打开 `ConnectionPool.sln` 文件。
2.  选择 "生成" -> "生成解决方案" (或按 `F7`) 来编译项目。
3.  生成的可执行文件位于 `x64/Debug/` 或 `x64/Release/` 目录下。

### 2. 配置

在运行程序前，请修改项目根目录下的 `mysql.ini` 配置文件，设置正确的数据库连接信息。

```ini
# 数据库连接池配置文件
ip=127.0.0.1
port=3306
username=root
password=your_password
dbname=your_database
initSize=10
maxSize=1024
# 最大空闲时间，单位：秒
maxIdleTime=60
# 获取连接超时时间，单位：毫秒
connectionTimeout=100
```

### 3. 代码示例

以下是如何在你的代码中使用连接池的简单示例：

```cpp
#include "ConnectionPool.h"
#include <iostream>
#include <memory>

int main() {
    // 1. 获取连接池实例 (单例)
    ConnectionPool* pool = ConnectionPool::getConnectionPool();

    // 2. 从连接池中获取一个数据库连接
    // 使用智能指针管理，当 shared_ptr 析构时，连接会自动归还到池中
    std::shared_ptr<Connection> conn = pool->getConnection();

    // 3. 使用获取到的连接执行 SQL
    if (conn) {
        const char* sql = "INSERT INTO user(name, age, sex) VALUES ('John Doe', 30, 'male')";
        if (conn->update(sql)) {
            std::cout << "插入成功！" << std::endl;
        }

        MYSQL_RES* res = conn->query("SELECT * FROM user");
        if (res != nullptr) {
            // 处理查询结果...
            mysql_free_result(res);
        }
    } else {
        std::cout << "获取连接失败！" << std::endl;
    }

    return 0;
}
```

## 性能测试

为了验证连接池在高并发场景下的性能优势，我们进行了压力测试。测试内容为分别在单线程和四线程环境下，执行指定数量的数据库 `INSERT` 操作，比较使用连接池和不使用连接池（即每次操作都创建新连接）的耗时。

### 测试结果

| 数据插入量 | 线程模型     | 未使用连接池 (耗时) | 使用连接池 (耗时) |
| ---------- | ------------ | ------------------- | ----------------- |
| **1,000**  | 单线程       | 5.2 秒              | 1.46 秒           |
|            | 四线程并发   | 1.77 秒             | 0.47 秒           |
| **5,000**  | 单线程       | 25.7 秒             | 5.78 秒           |
|            | 四线程并发   | 8.13 秒             | 2.1 秒            |
| **10,000** | 单线程       | 51.8 秒             | 11.4 秒           |
|            | 四线程并发   | 17.5 秒             | 4 秒              |

### 结论

从测试结果可以看出：

1.  **显著的性能提升**: 无论是在单线程还是多线程环境下，使用连接池都比不使用连接池有数倍的性能提升。数据量越大，性能优势越明显。
2.  **高并发优势**: 连接池在多线程并发场景下的优势尤为突出，它极大地减少了因频繁创建和销毁数据库连接所带来的系统开销。

## 配置项说明

| 参数                | 说明                                       | 单位   |
| ------------------- | ------------------------------------------ | ------ |
| `ip`                | 数据库服务器的 IP 地址                     | -      |
| `port`              | 数据库服务器的端口号                       | -      |
| `username`          | 登录数据库的用户名                         | -      |
| `password`          | 登录数据库的密码                           | -      |
| `dbname`            | 要连接的数据库名称                         | -      |
| `initSize`          | 连接池的初始连接数量                       | -      |
| `maxSize`           | 连接池的最大连接数量                       | -      |
| `maxIdleTime`       | 连接的最大空闲时间，超过此时间的连接将被回收 | 秒     |
| `connectionTimeout` | 获取数据库连接的超时时间                   | 毫秒   |

## 面试准备

本项目涵盖了 C++ 后台开发中的多个重要知识点。为了帮助您更好地理解和准备面试，我们整理了一份常见的面试问答文档。

➡️ **[点击查看：C++ 连接池项目面试宝典](./INTERVIEW.md)**

